<!-- Componente de gestión de amigos -->
<app-header-nav></app-header-nav>

<main class="amigos-container mt-3" role="main" aria-labelledby="page-title">
    <nav class="nav nav-tabs" role="tablist" aria-label="Navegación de amigos">
      <button class="nav-link active" 
              id="amigos-tab" 
              data-toggle="tab" 
              data-target="#amigos" 
              type="button" 
              role="tab" 
              aria-controls="amigos" 
              aria-selected="true">
        <i class="fa fa-users" aria-hidden="true"></i>
        Amigos
      </button>
      <button class="nav-link" 
              id="solicitudes-recibidas-tab" 
              data-toggle="tab" 
              data-target="#menuSolicitudesRecibidas" 
              type="button" 
              role="tab" 
              aria-controls="menuSolicitudesRecibidas" 
              aria-selected="false">
        <i class="fa fa-inbox" aria-hidden="true"></i>
        Solicitudes recibidas
      </button>
      <button class="nav-link" 
              id="solicitudes-rechazadas-tab" 
              data-toggle="tab" 
              data-target="#menuSolicitudesRechazadas" 
              type="button" 
              role="tab" 
              aria-controls="menuSolicitudesRechazadas" 
              aria-selected="false">
        <i class="fa fa-ban" aria-hidden="true"></i>
        Solicitudes rechazadas
      </button>
      <button class="nav-link" 
              id="solicitudes-enviadas-tab" 
              data-toggle="tab" 
              data-target="#menuSolicitudesEnviadas" 
              type="button" 
              role="tab" 
              aria-controls="menuSolicitudesEnviadas" 
              aria-selected="false">
        <i class="fa fa-paper-plane" aria-hidden="true"></i>
        Solicitudes enviadas
      </button>
      <button class="nav-link" 
              id="usuarios-recomendados-tab" 
              data-toggle="tab" 
              data-target="#menuUsuariosRecomendados" 
              type="button" 
              role="tab" 
              aria-controls="menuUsuariosRecomendados" 
              aria-selected="false">
        <i class="fa fa-star" aria-hidden="true"></i>
        Usuarios recomendados
      </button>
    </nav>

    <!-- Contenido de pestañas -->
    <div class="tab-content" id="amigosTabContent">
      <div id="amigos" 
           class="tab-pane fade show active" 
           role="tabpanel" 
           aria-labelledby="amigos-tab">
        
        <header class="section-header">
          <h2 id="page-title" class="section-title">
            <i class="fa fa-users" aria-hidden="true"></i>
            Mis Amigos
          </h2>
        </header>

        <!-- Estado de carga para amigos -->
        <div *ngIf="isLoadingAmigos" class="loading-container" role="status" aria-live="polite">
          <app-loadingPrincipal></app-loadingPrincipal>
          <span class="sr-only">Cargando lista de amigos...</span>
        </div>

        <!-- Estado de error -->
        <div *ngIf="hasError && !isLoadingAmigos" class="alert alert-danger" role="alert">
          <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
          <strong>Error:</strong> {{ errorMessage }}
          <button type="button" class="btn btn-sm btn-outline-danger ml-2" (click)="obtenerInformacionUsuario()">
            <i class="fa fa-refresh" aria-hidden="true"></i>
            Reintentar
          </button>
        </div>

        <!-- Lista de amigos -->
        <div *ngIf="InfoUsuario && InfoUsuario.amigos && InfoUsuario.amigos.length > 0 && !isLoadingAmigos && !hasError" 
             class="amigos-grid" 
             role="list" 
             aria-label="Lista de amigos">
          <article [id]="'amigo-' + amigo.id" 
                   *ngFor="let amigo of InfoUsuario.amigos; trackBy: trackByAmigoId" 
                   class="amigo-card" 
                   role="listitem">
            
            <div class="amigo-info">
              <div class="amigo-avatar">
                <a [routerLink]="['/perfil/', amigo.id]" 
                   [attr.aria-label]="'Ver perfil de ' + amigo.usuario"
                   class="avatar-link">
                  <img [src]="amigo.imagen" 
                       [alt]="'Avatar de ' + amigo.usuario"
                       class="avatar-image"
                       (load)="onImageLoad()"
                       (error)="onImageError($event)"
                       loading="lazy">
                </a>
              </div>
              
              <div class="amigo-details">
                <h3 class="amigo-nombre">
                  <a [routerLink]="['/perfil/', amigo.id]" 
                     [attr.aria-label]="'Ver perfil de ' + amigo.usuario"
                     class="nombre-link">
                    {{amigo.usuario}}
                  </a>
                </h3>
                
                <div class="amigo-acciones" role="group" [attr.aria-label]="'Acciones para ' + amigo.usuario">
                  <button type="button"
                          (click)="enviarMensaje(amigo.usuario, amigo.correo)" 
                          class="btn btn-success btn-accion"
                          [attr.aria-label]="'Enviar mensaje a ' + amigo.usuario">
                    <i class="fa fa-envelope" aria-hidden="true"></i>
                    <span>Enviar mensaje</span>
                  </button>
                  
                  <button type="button"
                          (click)="eliminarAmigo(amigo)" 
                          class="btn btn-danger btn-accion"
                          [attr.aria-label]="'Eliminar a ' + amigo.usuario + ' de amigos'">
                    <i class="fa fa-user-times" aria-hidden="true"></i>
                    <span>Eliminar amigo</span>
                  </button>
                </div>
              </div>
            </div>
          </article>
        </div>

        <!-- Estado vacío -->
        <div *ngIf="InfoUsuario && (!InfoUsuario.amigos || InfoUsuario.amigos.length === 0) && !isLoadingAmigos && !hasError" 
             class="empty-state" 
             role="status">
          <div class="empty-icon">
            <i class="fa fa-users fa-3x" aria-hidden="true"></i>
          </div>
          <h3 class="empty-title">No tienes amigos aún</h3>
          <p class="empty-description">Explora usuarios recomendados y envía solicitudes de amistad para empezar a conectar.</p>
          <button type="button" 
                  class="btn btn-primary"
                  data-toggle="tab" 
                  data-target="#menuUsuariosRecomendados">
            <i class="fa fa-star" aria-hidden="true"></i>
            Ver usuarios recomendados
          </button>
        </div>

      </div>

      <div id="menuSolicitudesRecibidas" 
           class="tab-pane fade" 
           role="tabpanel" 
           aria-labelledby="solicitudes-recibidas-tab">
        
        <header class="section-header">
          <h2 class="section-title">
            <i class="fa fa-inbox" aria-hidden="true"></i>
            Solicitudes Recibidas
          </h2>
        </header>

        <!-- Estado de carga para solicitudes -->
        <div *ngIf="isLoadingSolicitudes" class="loading-container" role="status" aria-live="polite">
          <app-loadingPrincipal></app-loadingPrincipal>
          <span class="sr-only">Cargando solicitudes de amistad...</span>
        </div>

        <!-- Lista de solicitudes recibidas -->
        <div *ngIf="InfoUsuario && InfoUsuario.solicitudesAmistadRecibidas && !isLoadingSolicitudes" 
             class="solicitudes-grid" 
             role="list" 
             aria-label="Lista de solicitudes de amistad recibidas">
          
          <ng-container *ngFor="let solicitud of InfoUsuario.solicitudesAmistadRecibidas; trackBy: trackBySolicitudUsuario">
            <article [id]="'solicitud-' + solicitud.usuario" 
                     class="solicitud-card"
                     role="listitem"
                     *ngIf="!solicitud.usuarioRechazado">
            
            <div class="solicitud-content">
              <div class="solicitud-avatar">
                <img [src]="solicitud.imagen" 
                     [alt]="'Avatar de ' + solicitud.usuario"
                     class="avatar-image"
                     (error)="onImageError($event)"
                     loading="lazy">
              </div>
              
              <div class="solicitud-info">
                <h3 class="solicitud-nombre">{{solicitud.usuario}}</h3>
                
                <div class="solicitud-descripcion" *ngIf="solicitud.descripcion">
                  <p>{{solicitud.descripcion}}</p>
                </div>

                <div class="solicitud-detalles">
                  <div class="detalle-seccion" *ngIf="solicitud.videojuegos && solicitud.videojuegos.length > 0">
                    <h4 class="detalle-titulo">
                      <i class="fa fa-gamepad" aria-hidden="true"></i>
                      Videojuegos
                    </h4>
                    <ul class="detalle-lista" role="list">
                      <li *ngFor="let juego of solicitud.videojuegos" role="listitem">
                        {{juego.nombre}}
                      </li>
                    </ul>
                  </div>

                  <div class="detalle-seccion" *ngIf="solicitud.plataformas && solicitud.plataformas.length > 0">
                    <h4 class="detalle-titulo">
                      <i class="fa fa-desktop" aria-hidden="true"></i>
                      Plataformas
                    </h4>
                    <ul class="detalle-lista" role="list">
                      <li *ngFor="let plata of solicitud.plataformas" role="listitem">
                        {{plata.nombre}}
                      </li>
                    </ul>
                  </div>
                </div>

                <div class="solicitud-acciones" role="group" [attr.aria-label]="'Acciones para solicitud de ' + solicitud.usuario">
                  <button type="button"
                          (click)="aceptarSolicitud(solicitud)" 
                          class="btn btn-success btn-accion"
                          [attr.aria-label]="'Aceptar solicitud de amistad de ' + solicitud.usuario">
                    <i class="fa fa-check" aria-hidden="true"></i>
                    <span>Aceptar</span>
                  </button>
                  
                  <button type="button"
                          (click)="cambiarStatusSolicitud(solicitud, true, '')" 
                          class="btn btn-danger btn-accion"
                          [attr.aria-label]="'Rechazar solicitud de amistad de ' + solicitud.usuario">
                    <i class="fa fa-times" aria-hidden="true"></i>
                    <span>Rechazar</span>
                  </button>
                </div>
              </div>
            </div>
          </article>
          </ng-container>
        </div>

        <!-- Estado vacío -->
        <div *ngIf="InfoUsuario && (!InfoUsuario.solicitudesAmistadRecibidas || InfoUsuario.solicitudesAmistadRecibidas.length === 0) && !isLoadingSolicitudes" 
             class="empty-state" 
             role="status">
          <div class="empty-icon">
            <i class="fa fa-inbox fa-3x" aria-hidden="true"></i>
          </div>
          <h3 class="empty-title">No tienes solicitudes pendientes</h3>
          <p class="empty-description">Las nuevas solicitudes de amistad aparecerán aquí.</p>
        </div>

      </div>

      <!-- Solicitudes Rechazadas -->
      <div id="menuSolicitudesRechazadas" 
           class="tab-pane fade" 
           role="tabpanel" 
           aria-labelledby="solicitudes-rechazadas-tab">
        
        <header class="section-header">
          <h2 class="section-title">
            <i class="fa fa-ban" aria-hidden="true"></i>
            Solicitudes Rechazadas
          </h2>
        </header>

        <div *ngIf="InfoUsuario && InfoUsuario.solicitudesAmistadRecibidas" 
             class="solicitudes-grid">
          <ng-container *ngFor="let solicitud of InfoUsuario.solicitudesAmistadRecibidas; trackBy: trackBySolicitudUsuario">
            <article [id]="'solicitud-rechazada-' + solicitud.usuario" 
                     class="solicitud-card solicitud-rechazada"
                     *ngIf="solicitud.usuarioRechazado">
            
            <div class="solicitud-content">
              <div class="solicitud-avatar">
                <img [src]="solicitud.imagen" 
                     [alt]="'Avatar de ' + solicitud.usuario"
                     class="avatar-image"
                     (error)="onImageError($event)"
                     loading="lazy">
              </div>
              
              <div class="solicitud-info">
                <h3 class="solicitud-nombre">{{solicitud.usuario}}</h3>
                <span class="solicitud-estado">Rechazada</span>
                
                <div class="solicitud-acciones">
                  <button type="button"
                          (click)="cambiarStatusSolicitud(solicitud, false, 'DivDiferente')" 
                          class="btn btn-warning btn-accion"
                          [attr.aria-label]="'Restaurar solicitud de ' + solicitud.usuario">
                    <i class="fa fa-undo" aria-hidden="true"></i>
                    <span>Restaurar</span>
                  </button>
                </div>
              </div>
            </div>
          </article>
          </ng-container>
        </div>

        <div *ngIf="!InfoUsuario?.solicitudesAmistadRecibidas || solicitudesRechazadasCount === 0" 
             class="empty-state">
          <div class="empty-icon">
            <i class="fa fa-ban fa-3x" aria-hidden="true"></i>
          </div>
          <h3 class="empty-title">No hay solicitudes rechazadas</h3>
          <p class="empty-description">Las solicitudes que rechaces aparecerán aquí.</p>
        </div>
      </div>

      <!-- Solicitudes Enviadas -->
      <div id="menuSolicitudesEnviadas" 
           class="tab-pane fade" 
           role="tabpanel" 
           aria-labelledby="solicitudes-enviadas-tab">
        
        <header class="section-header">
          <h2 class="section-title">
            <i class="fa fa-paper-plane" aria-hidden="true"></i>
            Solicitudes Enviadas
          </h2>
        </header>

        <div *ngIf="InfoUsuario && InfoUsuario.solicitudesAmistadEnviadas" 
             class="solicitudes-grid">
          <ng-container *ngFor="let solicitud of InfoUsuario.solicitudesAmistadEnviadas; trackBy: trackBySolicitudUsuario">
            <article [id]="'solicitud-enviada-' + solicitud.usuario" 
                     class="solicitud-card solicitud-enviada"
                     *ngIf="!solicitud.usuarioRechazado">
            
            <div class="solicitud-content">
              <div class="solicitud-avatar">
                <img [src]="solicitud.imagen" 
                     [alt]="'Avatar de ' + solicitud.usuario"
                     class="avatar-image"
                     (error)="onImageError($event)"
                     loading="lazy">
              </div>
              
              <div class="solicitud-info">
                <h3 class="solicitud-nombre">{{solicitud.usuario}}</h3>
                <span class="solicitud-estado">Pendiente</span>
                
                <div class="solicitud-acciones">
                  <button type="button"
                          (click)="eliminarSolicitud(solicitud)" 
                          class="btn btn-danger btn-accion"
                          [attr.aria-label]="'Cancelar solicitud enviada a ' + solicitud.usuario">
                    <i class="fa fa-times" aria-hidden="true"></i>
                    <span>Cancelar</span>
                  </button>
                </div>
              </div>
            </div>
          </article>
          </ng-container>
        </div>

        <div *ngIf="!InfoUsuario?.solicitudesAmistadEnviadas || InfoUsuario.solicitudesAmistadEnviadas.length === 0" 
             class="empty-state">
          <div class="empty-icon">
            <i class="fa fa-paper-plane fa-3x" aria-hidden="true"></i>
          </div>
          <h3 class="empty-title">No has enviado solicitudes</h3>
          <p class="empty-description">Busca usuarios recomendados y envía solicitudes de amistad.</p>
        </div>
      </div>

      <!-- Usuarios Recomendados -->
      <div id="menuUsuariosRecomendados" 
           class="tab-pane fade" 
           role="tabpanel" 
           aria-labelledby="usuarios-recomendados-tab">
        
        <header class="section-header">
          <h2 class="section-title">
            <i class="fa fa-star" aria-hidden="true"></i>
            Usuarios Recomendados
          </h2>
        </header>
        
        <div class="usuarios-recomendados">
          <app-usuariorecomendados></app-usuariorecomendados>
        </div>
      </div>

    </div>
</main>
